<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Writer's Block Studio</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- docx.js for DOCX export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.min.js"></script>
<style>
:root {
  --neon-blue: #0ff;
  --neon-dark: #055;
}

body {
  background-color: #111;
  color: white;
  font-family: sans-serif;
}

.text-neon-blue { color: var(--neon-blue); }
.bg-neon-blue { background-color: var(--neon-blue); }
input::placeholder, textarea::placeholder { color: var(--neon-blue); opacity: 0.8; }

.text-neon-3d {
  color: var(--neon-blue);
  font-weight: 900;
  text-shadow: 2px 2px 0 #08b, 4px 4px 0 #055, 6px 6px 0 #022;
}

button, .rhyme-btn {
  transition: all 0.2s ease-in-out;
  font-weight: 700;
}

button:hover, .rhyme-btn:hover {
  box-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue);
}

textarea, input {
  transition: all 0.2s ease-in-out;
}

#beatDropArea {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 2px dashed var(--neon-blue);
  border-radius: 12px;
  padding: 48px;
  width: 100%;
  max-width: 768px;
  background-color: #111;
  color: var(--neon-blue);
  text-align: center;
  transition: all 0.3s ease-in-out;
  cursor: pointer;
  overflow: hidden;
  margin-bottom: 16px;
}

#beatDropArea.dragover {
  background: linear-gradient(135deg, rgba(0,255,255,0.1), rgba(0,255,255,0.2));
  border-color: var(--neon-blue);
  transform: scale(1.02);
  opacity: 0.9;
}

#beatDropArea p {
  pointer-events: none;
  transition: all 0.3s ease-in-out;
}

.rhyme-btn {
  background-color: var(--neon-blue);
  color: #000;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-dark);
}
.rhyme-btn:hover {
  background-color: #08b;
  box-shadow: 0 0 15px var(--neon-blue), 0 0 25px var(--neon-dark);
}
</style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen flex flex-col items-center p-6">

<h1 class="text-6xl font-extrabold mb-10 text-neon-3d">Writer's Block</h1>

<!-- Beat Upload Section -->
<div id="beatDropArea">
  <p class="text-lg">Drag & Drop a beat here or click "Choose Beat"</p>
  <button id="chooseBeatBtn" class="bg-neon-blue text-black px-6 py-3 rounded mt-4">Choose Beat</button>
  <input type="file" id="beatUpload" class="hidden"/>
</div>

<!-- Beat Player Box -->
<div id="beatPlayerBox" class="flex flex-col items-center w-full max-w-3xl p-4 border-2 border-neon-blue rounded bg-gray-800 text-neon-blue hidden mb-8 mt-4">
  <p class="mb-2">Now Playing:</p>
  <audio id="beatPlayer" controls class="w-full h-12 rounded"></audio>
  <canvas id="beatVisualizer" class="w-full mt-4 rounded bg-gray-900"></canvas>
</div>

<!-- Input Section Above Lyrics -->
<div class="flex flex-col md:flex-row gap-4 mb-2 w-full max-w-3xl">
  <input id="inputLine" type="text" placeholder="Enter a word or phrase..."
    class="flex-1 p-3 rounded border-2 border-neon-blue bg-gray-800 text-neon-blue placeholder-neon-blue focus:outline-none focus:ring-2 focus:ring-neon-blue text-lg"/>
  <button id="generateBtn" class="bg-neon-blue text-black px-6 py-3 rounded text-lg">Generate</button>
  <button id="undoBtn" class="bg-gray-700 text-neon-blue px-6 py-3 rounded text-lg">Undo</button>
</div>

<!-- Rhyme Buttons Below Input -->
<div id="rhymeContainer" class="flex flex-wrap gap-3 mb-4 w-full max-w-3xl"></div>

<!-- Lyrics Textarea -->
<textarea id="lyricsArea"
  class="w-full max-w-3xl h-64 p-4 rounded border-2 border-neon-blue bg-gray-800 text-neon-blue focus:outline-none focus:ring-2 focus:ring-neon-blue text-lg resize-y"
  placeholder="Your lyrics go here..."></textarea>

<!-- Export Format Selection -->
<div class="flex gap-4 items-center mb-4">
  <label for="exportFormat" class="text-neon-blue font-bold">Export as:</label>
  <select id="exportFormat" class="p-2 rounded border-2 border-neon-blue bg-gray-800 text-neon-blue">
    <option value="txt">.txt</option>
    <option value="pdf">.pdf</option>
    <option value="docx">.docx</option>
  </select>
</div>

<!-- Save Lyrics -->
<button id="saveBtn" class="bg-neon-blue text-black px-8 py-3 rounded text-lg mt-2">Save Lyrics</button>

<script>
const inputLine = document.getElementById('inputLine');
const generateBtn = document.getElementById('generateBtn');
const undoBtn = document.getElementById('undoBtn');
const lyricsArea = document.getElementById('lyricsArea');
const saveBtn = document.getElementById('saveBtn');
const chooseBeatBtn = document.getElementById('chooseBeatBtn');
const beatUpload = document.getElementById('beatUpload');
const beatPlayer = document.getElementById('beatPlayer');
const beatDropArea = document.getElementById('beatDropArea');
const beatPlayerBox = document.getElementById('beatPlayerBox');
const rhymeContainer = document.getElementById('rhymeContainer');
const exportFormat = document.getElementById('exportFormat');

let historyStack = [];

// --- Beat Upload ---
chooseBeatBtn.addEventListener('click', () => beatUpload.click());
beatUpload.addEventListener('change', handleBeatFile);
beatDropArea.addEventListener('dragover', e => { e.preventDefault(); beatDropArea.classList.add('dragover'); });
beatDropArea.addEventListener('dragleave', e => { e.preventDefault(); beatDropArea.classList.remove('dragover'); });
beatDropArea.addEventListener('drop', e => {
  e.preventDefault();
  beatDropArea.classList.remove('dragover');
  if(e.dataTransfer.files.length){
    beatUpload.files = e.dataTransfer.files;
    handleBeatFile();
  }
});
function handleBeatFile(){
  const file = beatUpload.files[0];
  if(!file) return;
  if(!file.type.startsWith('audio/')) { alert('Please select a valid audio file'); beatUpload.value = ''; return; }
  beatPlayer.src = URL.createObjectURL(file);
  beatPlayerBox.classList.remove('hidden');
}

// --- Append lyrics ---
function appendLyrics(line){ historyStack.push(lyricsArea.value); lyricsArea.value += lyricsArea.value ? '\n' + line : line; lyricsArea.scrollTop = lyricsArea.scrollHeight; }

// --- Shuffle ---
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// --- Generate rhymes ---
async function generateRhyme() {
  const phrase = inputLine.value.trim();
  if (!phrase) return;
  const words = phrase.split(' ');
  const lastWord = words[words.length - 1];

  try {
    const res = await fetch(`https://api.datamuse.com/words?rel_rhy=${lastWord}&max=20`);
    let data = await res.json();
    if (data.length === 0) { appendLyrics(`(No rhymes found for '${lastWord}')`); rhymeContainer.innerHTML = ''; return; }

    data = shuffleArray(data).slice(0, 10);
    rhymeContainer.innerHTML = '';
    data.forEach(item => {
      const btn = document.createElement('button');
      btn.className = 'rhyme-btn';
      btn.textContent = item.word;
      btn.addEventListener('click', () => {
        const lines = lyricsArea.value.split('\n');
        lines.pop();
        lines.push(item.word);
        lyricsArea.value = lines.join('\n');
      });
      rhymeContainer.appendChild(btn);
    });
    appendLyrics(data[0].word);
    rhymeContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (err) {
    console.error(err);
    appendLyrics('(Error generating rhyme)');
  }
}

// --- Events ---
generateBtn.addEventListener('click', generateRhyme);
inputLine.addEventListener('keypress', e => { if(e.key==='Enter') generateRhyme(); });
undoBtn.addEventListener('click',()=>{ if(historyStack.length>0) lyricsArea.value=historyStack.pop(); });

// --- Save with format selection ---
saveBtn.addEventListener('click', async () => {
  const text = lyricsArea.value;
  const defaultFileName = 'lyrics';
  const fileNameInput = prompt('Enter file name', defaultFileName) || defaultFileName;
  const format = exportFormat.value;

  if (format === 'txt') {
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${fileNameInput}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  else if (format === 'pdf') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const lines = doc.splitTextToSize(text, 180);
    doc.text(lines, 10, 10);
    doc.save(`${fileNameInput}.pdf`);
  }

  else if (format === 'docx') {
    const doc = new window.docx.Document();
    const paragraphs = text.split('\n').map(line => new window.docx.Paragraph(line));
    doc.addSection({ children: paragraphs });
    const packer = new window.docx.Packer();
    packer.toBlob(doc).then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${fileNameInput}.docx`;
      a.click();
      URL.revokeObjectURL(url);
    });
  }
});

// --- Neon Beat Visualizer ---
let audioContext, analyser, source, freqDataArray, timeDataArray, bufferLength;
const canvas = document.getElementById('beatVisualizer');
const ctx = canvas.getContext('2d');

beatPlayer.addEventListener('play', () => {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    source = audioContext.createMediaElementSource(beatPlayer);
    source.connect(analyser);
    analyser.connect(audioContext.destination);

    analyser.fftSize = 2048;
    bufferLength = analyser.frequencyBinCount;

    freqDataArray = new Uint8Array(bufferLength);
    timeDataArray = new Uint8Array(bufferLength);
  }
  drawCombinedVisualizer();
});

function drawCombinedVisualizer() {
  if (beatPlayer.paused) return;
  requestAnimationFrame(drawCombinedVisualizer);

  analyser.getByteFrequencyData(freqDataArray);
  analyser.getByteTimeDomainData(timeDataArray);

  canvas.width = canvas.clientWidth;
  canvas.height = 150;

  const neonIntensity = Math.min(1, freqDataArray.reduce((a,b)=>a+b,0)/freqDataArray.length/200);
  ctx.fillStyle = `rgba(0,255,255,${0.05+neonIntensity*0.15})`;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const neonGradient = ctx.createLinearGradient(0,0,0,canvas.height);
  neonGradient.addColorStop(0, `rgba(0,255,255,${neonIntensity})`);
  neonGradient.addColorStop(0.5, `rgba(0,200,255,0.6)`);
  neonGradient.addColorStop(1, `rgba(0,100,255,0.2)`);

  const barWidth = (canvas.width/bufferLength)*2;
  let x=0;
  for(let i=0;i<bufferLength;i++){
    const barHeight=freqDataArray[i]*0.8;
    ctx.fillStyle=neonGradient;
    ctx.shadowColor='#0ff';
    ctx.shadowBlur=15;
    const pulseHeight=i<5?barHeight*1.5:barHeight;
    ctx.fillRect(x,canvas.height-pulseHeight/2,barWidth,pulseHeight/2);
    x+=barWidth+1;
  }

  ctx.lineWidth=2;
  ctx.strokeStyle='#0ff';
  ctx.shadowColor='#0ff';
  ctx.shadowBlur=20;
  ctx.beginPath();
  const sliceWidth=canvas.width/bufferLength;
  let sx=0;
  for(let i=0;i<bufferLength;i++){
    const v=timeDataArray[i]/128.0;
    const y=v*canvas.height/2;
    if(i===0) ctx.moveTo(sx,y); else ctx.lineTo(sx,y);
    sx+=sliceWidth;
  }
  ctx.lineTo(canvas.width,canvas.height/2);
  ctx.stroke();
}
</script>

</body>
</html>
